<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Micro:bit å‡½æ•¸é­”æ³•æ•™å®¤ v3.4 (å®Œç¾ä¿®å¾©ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Consolas&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f0f9ff;
            touch-action: none;
        }

        /* --- åŸæœ‰æ•™å­¸æ¨£å¼ --- */
        .step-active { border-bottom: 3px solid #3B82F6; color: #1D4ED8; font-weight: bold; }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- éŠæˆ²å°ˆç”¨ CSS --- */
        :root {
            --block-event: #993399; 
            --block-func: #1b2c45;  
            --block-call: #2c3e50;  
            --block-loop: #16a34a;  
            --block-logic: #0891b2; 
            --block-action: #d97706;
        }

        .game-wrapper {
            display: flex; flex-direction: column; height: 700px;
            background: white; border: 1px solid #e2e8f0; border-radius: 12px;
            overflow: hidden; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .game-header {
            padding: 12px 16px; border-bottom: 1px solid #e2e8f0; background: #f8fafc;
            display: flex; justify-content: space-between; align-items: center; height: 60px;
        }

        .game-body { display: flex; flex: 1; overflow: hidden; position: relative; }

        /* å·¦å´ï¼šèˆå°å€ */
        .stage-area {
            flex: 4; background: #f1f5f9; padding: 16px;
            display: flex; flex-direction: column; border-right: 1px solid #e2e8f0; 
            position: relative; overflow: hidden;
        }

        .mission-card {
            background: white; padding: 10px 14px; border-radius: 8px;
            border-left: 4px solid #f59e0b; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            margin-bottom: 12px; font-size: 0.95rem; line-height: 1.5; z-index: 20;
        }

        #canvas {
            flex: 1; 
            background: white; 
            border-radius: 8px; 
            border: 2px solid #cbd5e1;
            position: relative !important;
            overflow: hidden !important; 
            background-image: radial-gradient(#e2e8f0 1px, transparent 1px); 
            background-size: 20px 20px;
            z-index: 0;
        }

        /* å³å´ï¼šç¨‹å¼å€ */
        .code-area {
            flex: 6; display: flex; flex-direction: column; background: white; position: relative;
        }

        #toolbox {
            padding: 10px; background: #f8fafc; border-bottom: 1px solid #e2e8f0;
            display: flex; flex-wrap: wrap; gap: 8px;
            align-content: flex-start;
            min-height: 80px; max-height: 150px; overflow-y: auto;
        }

        #workspace {
            flex: 1; padding: 20px; background-color: #ffffff; 
            overflow-y: auto; position: relative;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
        }

        /* --- ç©æœ¨æ¨£å¼ --- */
        .game-block {
            padding: 6px 10px; margin: 4px 0; color: white;
            font-family: 'Consolas', monospace; font-size: 13px; font-weight: 600;
            border-radius: 6px; cursor: grab;
            display: inline-flex; flex-direction: column; align-items: flex-start;
            box-shadow: 1px 1px 3px rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.2);
            user-select: none; z-index: 10; width: fit-content;
            transition: transform 0.1s;
        }
        .game-block:active { transform: scale(0.98); cursor: grabbing; }

        .block-header { display: flex; align-items: center; pointer-events: none; white-space: nowrap;}
        
        .block-event { background: var(--block-event); border-radius: 8px 8px 4px 4px; margin-top: 10px;}
        .block-func { background: var(--block-func); margin-bottom: 10px; border: 2px solid #fbbf24;}
        .block-call { background: var(--block-call); flex-direction: row;}
        .block-loop { background: var(--block-loop); border-radius: 4px 12px 4px 4px;}
        .block-logic { background: var(--block-logic); border-radius: 4px;}
        .block-action { background: var(--block-action); flex-direction: row;}

        .game-slot {
            background: rgba(0,0,0,0.05); min-height: 40px;
            margin: 4px 0 4px 12px; border-left: 3px solid rgba(0,0,0,0.1);
            border-radius: 4px; padding: 4px; min-width: 140px; width: 95%; 
            transition: all 0.2s;
        }
        .game-slot.drag-over { background: #bbf7d0; border: 2px dashed #16a34a; }

        .sprite { 
            position: absolute !important; 
            transition: left 0.5s cubic-bezier(0.4, 0, 0.2, 1), top 0.5s ease; 
            width: 60px; height: 60px;
            z-index: 10;
        }
        
        .target-svg { display: flex; justify-content: center; align-items: center; }
        .target-svg.broken { filter: grayscale(100%) brightness(0.8); }
        .target-svg.red-alert { filter: sepia(100%) hue-rotate(-50deg) saturate(300%); }
        .target-svg.fixed { 
            filter: grayscale(0%) drop-shadow(0 0 10px #22c55e); 
            transform: scale(1.1);
            transform-origin: center bottom;
        }
        .target-svg.shield { filter: drop-shadow(0 0 5px #0ea5e9); }
        
        .beam {
            position: absolute; height: 6px; background: #22c55e;
            border-radius: 3px; z-index: 50; opacity: 0;
            transform-origin: left center;
            box-shadow: 0 0 8px #22c55e;
            pointer-events: none;
            transition: opacity 0.1s;
        }

        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); }
            75% { transform: translateX(-5px); }
            100% { transform: translateX(0); }
        }
        .shake { animation: shake 0.4s ease-in-out; }

        .tag { display: inline-block; background: #f1f5f9; color: #475569; padding: 1px 5px; border-radius: 4px; font-family: monospace; font-size: 0.9em; border: 1px solid #cbd5e1; }
        .code-block-demo { padding: 4px 8px; border-radius: 4px; color: white; font-weight: bold; font-family: monospace; display: inline-block; }
    </style>
</head>
<body class="flex flex-col min-h-screen text-slate-800">

    <nav class="bg-white shadow-md p-4 sticky top-0 z-50">
        <div class="max-w-5xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2">
                <i data-lucide="cpu" class="text-blue-600"></i>
                <h1 class="text-xl font-bold text-slate-800">Micro:bit å‡½æ•¸é­”æ³•æ•™å®¤</h1>
            </div>
            <div class="text-sm text-slate-500 hidden md:block">äº’å‹•å¼æ•™å­¸ç³»çµ± v3.4</div>
        </div>
    </nav>

    <main class="flex-grow p-4 md:p-8 max-w-5xl mx-auto w-full">
        <div class="flex justify-between mb-8 overflow-x-auto pb-2" id="progressBar"></div>
        <div id="contentArea" class="bg-white rounded-2xl shadow-xl p-6 md:p-10 min-h-[600px] relative fade-in"></div>
        <div class="flex justify-between mt-6 max-w-5xl mx-auto">
            <button id="prevBtn" onclick="changeStep(-1)" class="px-6 py-2 bg-slate-200 hover:bg-slate-300 rounded-lg font-semibold text-slate-700 transition disabled:opacity-50 disabled:cursor-not-allowed">
                <i data-lucide="arrow-left" class="inline w-4 h-4 mb-1"></i> ä¸Šä¸€æ­¥
            </button>
            <button id="nextBtn" onclick="changeStep(1)" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg font-semibold text-white transition disabled:opacity-50 disabled:cursor-not-allowed">
                ä¸‹ä¸€æ­¥ <i data-lucide="arrow-right" class="inline w-4 h-4 mb-1"></i>
            </button>
        </div>
    </main>

    <footer class="bg-slate-100 py-6 text-center text-slate-500 text-sm mt-8">
        <p>Micro:bit å‡½æ•¸æ•™å­¸å–®å…ƒ | Designed for Education</p>
    </footer>

    <script>
        // --- éŸ³æ•ˆç³»çµ± ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;

            if (type === 'click') {
                osc.type = 'triangle'; osc.frequency.setValueAtTime(600, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                osc.start(now); osc.stop(now + 0.1);
            } else if (type === 'laser') {
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(800, now);
                osc.frequency.exponentialRampToValueAtTime(100, now + 0.2);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
                osc.start(now); osc.stop(now + 0.2);
            } else if (type === 'success') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(500, now);
                osc.frequency.setValueAtTime(1000, now + 0.1);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.4);
                osc.start(now); osc.stop(now + 0.4);
            } else if (type === 'fail') {
                osc.type = 'square'; osc.frequency.setValueAtTime(150, now);
                osc.frequency.linearRampToValueAtTime(100, now + 0.4);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.4);
                osc.start(now); osc.stop(now + 0.4);
            }
        }

        // --- Data & Render ---
        const tutorialSteps = [
            {
                id: "intro", title: "1. ç‚ºä»€éº¼å­¸å‡½æ•¸ï¼Ÿ", icon: "help-circle",
                render: () => `
                    <div class="space-y-6 text-center">
                        <h2 class="text-3xl font-bold text-blue-700">ä½ æœ‰é‡éé€™ç¨®éº»ç…©å—ï¼Ÿ</h2>
                        <p class="text-lg text-slate-600">å¦‚æœè¦è®“ Micro:bit é–ƒçˆæ„›å¿ƒä¸‰æ¬¡ï¼Œä½ æœƒæ€éº¼å¯«ç¨‹å¼ï¼Ÿ</p>
                        <div class="grid md:grid-cols-2 gap-8 items-center mt-8">
                            <div class="bg-red-50 p-4 rounded-xl border-2 border-red-200">
                                <h3 class="font-bold text-red-600 mb-2">âŒ æ²’ç”¨å‡½æ•¸ (ç´¯æ­»äººå¯«æ³•)</h3>
                                <div class="text-left text-xs space-y-1 opacity-70">
                                    <div class="code-block-demo bg-emerald-500">é¡¯ç¤ºåœ–ç¤º â¤ï¸</div>
                                    <div class="code-block-demo bg-emerald-500">æš«åœ 500ms</div>
                                    <div class="code-block-demo bg-emerald-500">é¡¯ç¤ºåœ–ç¤º â¤ï¸</div>
                                    <div class="code-block-demo bg-emerald-500">...è¤‡è£½è²¼ä¸Šå¥½å¤šæ¬¡</div>
                                </div>
                                <p class="mt-4 text-sm text-red-500">ç¨‹å¼ç¢¼è¶…é•·ï¼Œä¿®æ”¹å¾ˆéº»ç…©ï¼</p>
                            </div>
                            <div class="bg-green-50 p-4 rounded-xl border-2 border-green-200">
                                <h3 class="font-bold text-green-600 mb-2">âœ… ä½¿ç”¨å‡½æ•¸ (è°æ˜å¯«æ³•)</h3>
                                <div class="text-left text-xs space-y-1">
                                    <div class="code-block-demo bg-blue-800">å»ºç«‹å‡½æ•¸ "é–ƒçˆ"</div>
                                    <div class="ml-4 p-2 bg-blue-100 rounded"><div class="code-block-demo bg-emerald-500">é¡¯ç¤ºåœ–ç¤º...</div></div>
                                    <div class="mt-4 code-block-demo bg-green-500">é‡è¤‡ 3 æ¬¡</div>
                                    <div class="ml-4 p-2 bg-green-100 rounded"><div class="code-block-demo bg-blue-800">å‘¼å« "é–ƒçˆ"</div></div>
                                </div>
                                <p class="mt-4 text-sm text-green-600">å®šç¾©ä¸€æ¬¡ï¼Œéš¨æ™‚å‘¼å«ï¼</p>
                            </div>
                        </div>
                    </div>`
            },
            {
                id: "concept", title: "2. å‡½æ•¸æ˜¯ä»€éº¼ï¼Ÿ", icon: "book-open",
                render: () => `
                    <div class="space-y-6">
                        <h2 class="text-2xl font-bold text-slate-800"><i data-lucide="package" class="inline text-purple-500"></i> å‡½æ•¸ (Function) çš„æ¦‚å¿µ</h2>
                        <div class="bg-blue-50 p-6 rounded-xl border-l-4 border-blue-500">
                            <p class="text-lg"><strong>å‡½æ•¸</strong>å°±åƒæ˜¯ä¸€å€‹<strong>ã€Œæ‰“åŒ…å¥½çš„é­”æ³•ç®±å­ã€</strong>ã€‚<br>ä½ æŠŠä¸€å †æŒ‡ä»¤æ”¾é€²å»ï¼Œçµ¦å®ƒä¸€å€‹åå­—ï¼Œä¹‹å¾Œåªè¦å«é€™å€‹åå­—ï¼Œè£¡é¢çš„æŒ‡ä»¤å°±æœƒè‡ªå‹•åŸ·è¡Œï¼</p>
                        </div>
                        <div class="grid md:grid-cols-2 gap-6 mt-6">
                            <div class="bg-white border rounded p-4"><h3 class="font-bold">ç‰¹é» 1ï¼šæ‰“åŒ…æŒ‡ä»¤</h3><p>å°‡è¤‡é›œå‹•ä½œçµ„åˆæˆä¸€å€‹æ–°å‹•ä½œã€‚</p></div>
                            <div class="bg-white border rounded p-4"><h3 class="font-bold">ç‰¹é» 2ï¼šé‡è¤‡ä½¿ç”¨</h3><p>å¯«ä¸€æ¬¡ï¼Œå¯ä»¥å‘¼å« 100 æ¬¡ã€‚</p></div>
                        </div>
                    </div>`
            },
            {
                id: "flow", title: "3. é‹ä½œæµç¨‹", icon: "activity",
                render: () => `
                    <div class="space-y-6">
                        <h2 class="text-2xl font-bold text-slate-800">ç¨‹å¼æ˜¯æ€éº¼è·‘çš„ï¼Ÿ</h2>
                        <div class="bg-slate-800 p-6 rounded-xl text-white">
                            <div class="grid grid-cols-2 gap-8">
                                <div class="border border-slate-600 p-4 rounded bg-slate-700/50" id="mainProgramArea">
                                    <h4 class="text-sm text-slate-400 mb-2">ä¸»ç¨‹å¼</h4>
                                    <div id="step1" class="code-block-demo bg-green-500 w-full mb-2 opacity-30">1. Start</div>
                                    <div id="step2" class="code-block-demo bg-blue-900 w-full mb-2 opacity-30">2. å‘¼å« "ç¬‘è‡‰"</div>
                                    <div id="step4" class="code-block-demo bg-green-500 w-full opacity-30">3. End</div>
                                </div>
                                <div class="border border-slate-600 p-4 rounded bg-slate-700/50" id="funcDefArea">
                                    <h4 class="text-sm text-slate-400 mb-2">å‡½æ•¸ "ç¬‘è‡‰"</h4>
                                    <div class="p-2 border border-dashed border-blue-400 rounded">
                                        <div id="step3a" class="code-block-demo bg-emerald-500 w-full mb-2 opacity-30">LED é¡¯ç¤º :)</div>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-6 flex justify-between items-center">
                                <div id="flowStatus" class="text-yellow-400 font-mono">æº–å‚™åŸ·è¡Œ...</div>
                                <button onclick="runFlowSimulation()" class="px-4 py-2 bg-green-600 rounded font-bold"><i data-lucide="play" class="inline"></i> åŸ·è¡Œ</button>
                            </div>
                        </div>
                    </div>`
            },
            {
                id: "life", title: "4. ç”Ÿæ´»ä¸­çš„æ‡‰ç”¨", icon: "coffee",
                render: () => `
                    <div class="space-y-6">
                        <h2 class="text-2xl font-bold text-slate-800">ç”Ÿæ´»ä¸­çš„å‡½æ•¸</h2>
                        <div class="grid md:grid-cols-3 gap-6">
                            <div class="bg-white p-6 shadow rounded-xl"><i data-lucide="music" class="text-indigo-500 mb-2"></i><h3 class="font-bold">å‰¯æ­Œ (Chorus)</h3><p>è­œä¸Šå¯«ã€Œå›åˆ°å‰¯æ­Œã€ï¼Œä¸ç”¨é‡å¯«éŸ³ç¬¦ã€‚</p></div>
                            <div class="bg-white p-6 shadow rounded-xl"><i data-lucide="shirt" class="text-sky-500 mb-2"></i><h3 class="font-bold">æ´—è¡£æ¨¡å¼</h3><p>æŒ‰ä¸€é¡†æŒ‰éˆ•ï¼Œè‡ªå‹•åŸ·è¡Œã€Œæµ¸æ³¡+æ´—æ»Œ+è„«æ°´ã€ã€‚</p></div>
                            <div class="bg-white p-6 shadow rounded-xl"><i data-lucide="utensils" class="text-orange-500 mb-2"></i><h3 class="font-bold">é€Ÿé£Ÿåº—å¥—é¤</h3><p>èªªã€Œ1è™Ÿé¤ã€ï¼Œä¸ç”¨èªªã€Œæ¼¢å ¡+è–¯æ¢+å¯æ¨‚ã€ã€‚</p></div>
                        </div>
                    </div>`
            },
            {
                id: "practice", title: "5. é‚è¼¯å·¥ç¨‹å¸«æŒ‘æˆ°", icon: "gamepad-2",
                render: () => `
                    <div class="game-wrapper font-sans">
                        <div class="game-header">
                             <div class="font-bold text-slate-700 text-lg flex gap-2 items-center">
                                <i data-lucide="gamepad-2" class="text-purple-600"></i> é‚è¼¯è¨“ç·´
                             </div>
                             <div id="game-level-display" class="bg-blue-600 text-white px-4 py-1 rounded-full text-sm font-bold shadow">Level 1</div>
                        </div>
                        
                        <div class="game-body">
                            <div class="stage-area">
                                 <div class="mission-card">
                                    <div class="text-xs font-bold text-slate-400 uppercase mb-1 flex items-center gap-1"><i data-lucide="alert-circle" class="w-3 h-3"></i> ç•¶å‰ä»»å‹™</div>
                                    <div id="mission-text" class="text-slate-700 font-medium leading-relaxed">Loading...</div>
                                 </div>
                                 <div id="canvas">
                                    <svg class="sprite robot-svg" id="robot" viewBox="0 0 100 100" style="left: 20px; top: 320px; z-index: 20;">
                                        <circle cx="50" cy="50" r="45" fill="#cfd8dc" stroke="#37474f" stroke-width="2"/>
                                        <rect x="25" y="35" width="50" height="30" rx="5" fill="#37474f"/>
                                        <circle class="eye" cx="38" cy="50" r="5" fill="#22c55e"/>
                                        <circle class="eye" cx="62" cy="50" r="5" fill="#22c55e"/>
                                        <rect x="40" y="80" width="20" height="15" fill="#546e7a"/>
                                        <path d="M50 20 L50 5" stroke="#37474f" stroke-width="2"/>
                                        <circle cx="50" cy="5" r="3" fill="#ef4444"/>
                                    </svg>
                                    <div class="beam" id="beam"></div>
                                 </div>
                            </div>

                            <div class="code-area">
                                <div id="toolbox"></div>
                                <div id="workspace">
                                     <div id="empty-hint" class="text-center text-slate-300 mt-20 pointer-events-none select-none text-sm">â˜Ÿ æ‹–æ”¾ç©æœ¨åˆ°é€™è£¡çµ„åˆç¨‹å¼</div>
                                </div>
                                <div class="p-4 border-t border-slate-100 flex items-center gap-2 bg-white">
                                    <div id="game-msg-box" class="flex-1 font-bold text-slate-500 text-sm truncate">æº–å‚™å°±ç·’</div>
                                    <button onclick="loadGameLevel(currentGameLevelIdx)" class="px-3 py-2 bg-slate-100 hover:bg-slate-200 rounded text-slate-600 font-bold text-sm transition border">
                                        <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
                                    </button>
                                    <button onclick="runGameCode()" class="px-6 py-2 bg-green-500 hover:bg-green-600 rounded text-white font-bold text-sm shadow btn-run flex items-center gap-2">
                                        <i data-lucide="play" class="w-4 h-4"></i> åŸ·è¡Œ
                                    </button>
                                    <button id="btn-next-level" onclick="nextGameLevel()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded text-white font-bold text-sm shadow hidden animate-bounce flex items-center gap-1">
                                        ä¸‹ä¸€é—œ <i data-lucide="arrow-right" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>`
            }
        ];

        let currentStep = 0;

        function init() {
            renderProgressBar();
            loadStep(0);
        }

        function renderProgressBar() {
            const container = document.getElementById('progressBar');
            container.innerHTML = tutorialSteps.map((step, index) => `
                <button onclick="loadStep(${index})" 
                    class="flex items-center gap-2 px-4 py-2 rounded-full whitespace-nowrap transition-colors mr-2
                    ${index === currentStep ? 'bg-blue-600 text-white shadow-md' : 'bg-white text-slate-500 hover:bg-slate-100'}">
                    <span class="w-6 h-6 flex items-center justify-center rounded-full text-xs font-bold ${index === currentStep ? 'bg-white text-blue-600' : 'bg-slate-200'}">${index + 1}</span>
                    <span>${step.title.split('.')[1]}</span>
                </button>
            `).join('');
        }

        function loadStep(index) {
            currentStep = index;
            document.getElementById('contentArea').innerHTML = tutorialSteps[index].render();
            document.getElementById('prevBtn').disabled = index === 0;
            document.getElementById('nextBtn').disabled = index === tutorialSteps.length - 1;
            renderProgressBar();
            lucide.createIcons();
            window.scrollTo({ top: 0, behavior: 'smooth' });

            if (tutorialSteps[index].id === 'practice') {
                initGame();
            }
        }

        function changeStep(delta) {
            const newStep = currentStep + delta;
            if (newStep >= 0 && newStep < tutorialSteps.length) {
                loadStep(newStep);
            }
        }

        /* --- Flow Simulation --- */
        async function runFlowSimulation() {
            playSound('click');
            const els = {
                step1: document.getElementById('step1'),
                step2: document.getElementById('step2'),
                step3a: document.getElementById('step3a'),
                step4: document.getElementById('step4'),
                status: document.getElementById('flowStatus'),
                mainArea: document.getElementById('mainProgramArea'),
                funcArea: document.getElementById('funcDefArea')
            };

            const reset = () => {
                Object.values(els).forEach(el => {
                    if(el && el.classList) el.classList.remove('ring-4', 'ring-yellow-400', 'opacity-100');
                    if(el && el.id && el.id.startsWith('step')) el.classList.add('opacity-30');
                });
                els.status.innerText = "æº–å‚™åŸ·è¡Œ...";
            };
            const highlight = (el, text) => {
                el.classList.remove('opacity-30');
                el.classList.add('ring-2', 'ring-yellow-400', 'opacity-100');
                els.status.innerText = text;
            };

            reset();
            highlight(els.step1, "ä¸»ç¨‹å¼: é¡¯ç¤º Start");
            await new Promise(r => setTimeout(r, 1000));
            els.step1.classList.remove('ring-2', 'ring-yellow-400');

            highlight(els.step2, "ä¸»ç¨‹å¼: å‘¼å«å‡½æ•¸ 'ç¬‘è‡‰'...");
            await new Promise(r => setTimeout(r, 1000));
            els.step2.classList.remove('ring-2', 'ring-yellow-400');

            els.mainArea.classList.add('opacity-50');
            els.funcArea.classList.add('ring-2', 'ring-blue-500');
            
            highlight(els.step3a, "å‡½æ•¸å…§: åŸ·è¡Œ LED é¡¯ç¤º");
            await new Promise(r => setTimeout(r, 1000));
            els.step3a.classList.remove('ring-2', 'ring-yellow-400');

            els.funcArea.classList.remove('ring-2', 'ring-blue-500');
            els.mainArea.classList.remove('opacity-50');
            els.status.innerText = "å‡½æ•¸çµæŸï¼Œè¿”å›ä¸»ç¨‹å¼";
            await new Promise(r => setTimeout(r, 800));

            highlight(els.step4, "ä¸»ç¨‹å¼: é¡¯ç¤º End");
            await new Promise(r => setTimeout(r, 1000));
            els.status.innerText = "ç¨‹å¼åŸ·è¡Œå®Œç•¢";
            els.step4.classList.remove('ring-2', 'ring-yellow-400');
            playSound('success');
        }

        /* --- Game Engine (é‚è¼¯ä¿®æ­£ç‰ˆ) --- */
        const gameSVGs = {
            server: `<svg viewBox="0 0 100 100"><rect x="15" y="10" width="70" height="80" rx="4" fill="#64748b"/><rect x="25" y="20" width="50" height="10" rx="2" fill="#334155"/><circle cx="30" cy="25" r="2" fill="#ef4444" class="status-light"/><rect x="25" y="40" width="50" height="10" rx="2" fill="#334155"/><circle cx="30" cy="45" r="2" fill="#ef4444" class="status-light"/><rect x="25" y="60" width="50" height="10" rx="2" fill="#334155"/><circle cx="30" cy="65" r="2" fill="#ef4444" class="status-light"/></svg>`,
            shield: `<svg viewBox="0 0 100 100"><path d="M50 10 L90 25 V55 C90 75 50 95 50 95 C50 95 10 75 10 55 V25 Z" fill="#475569" stroke="#0ea5e9" stroke-width="3"/><text x="35" y="65" fill="white" font-size="40" font-weight="bold">!</text></svg>`
        };

        const gameLevels = [
            {
                id: 1, title: "L1: å®šç¾©å·¥å…·",
                desc: "ä»»å‹™ï¼šå®šç¾©ä¸€å€‹ <span class='tag'>å‡½æ•¸:ä¿®å¾©</span>ï¼Œè£¡é¢æ”¾å…¥ <span class='tag'>å‹•ä½œ:ç™¼å°„å…‰æŸ</span>ã€‚<br><span class='text-xs text-slate-500'>æç¤ºï¼šæŠŠå‹•ä½œç©æœ¨æ‹–é€²å‡½æ•¸ç©æœ¨è£¡ã€‚</span>",
                targets: [{type: 'server', status: 'broken'}],
                blocks: [{type: 'func', text: 'å‡½æ•¸: ä¿®å¾©', isContainer: true}, {type: 'action', text: 'å‹•ä½œ: ç™¼å°„å…‰æŸ'}],
                check: (ws) => {
                    const func = ws.querySelector('.block-func');
                    if(!func || !func.querySelector('.block-action')) return {pass: false, msg: "è«‹æŠŠã€Œå‹•ä½œã€æ”¾å…¥ã€Œå‡½æ•¸ã€è£¡é¢ï¼"};
                    return {pass: true, actions: [{type: 'fix', index: 0}]};
                }
            },
            {
                id: 2, title: "L2: å‘¼å«å‡½æ•¸",
                desc: "ä»»å‹™ï¼šç•¶ <span class='tag'>æŒ‰éˆ•A</span> æŒ‰ä¸‹æ™‚ï¼Œ<span class='tag'>å‘¼å«:ä¿®å¾©</span>ã€‚<br><span class='text-xs text-slate-500'>* ä½ å»ºç«‹çš„å‡½æ•¸å·²ç¶“æº–å‚™å¥½äº†ï¼ç›´æ¥å‘¼å«å®ƒå§ã€‚</span>",
                targets: [{type: 'server', status: 'broken'}],
                blocks: [{type: 'event', text: 'ç•¶æŒ‰éˆ• A è¢«æŒ‰ä¸‹', isContainer: true}, {type: 'call', text: 'å‘¼å«: ä¿®å¾©'}],
                preset: [{type: 'func', text: 'å‡½æ•¸: ä¿®å¾©', isContainer: true, children: [{type: 'action', text: 'å‹•ä½œ: ç™¼å°„å…‰æŸ'}]}],
                check: (ws) => {
                    const evt = ws.querySelector('.block-event');
                    if(!evt || !evt.querySelector('.block-call')) return {pass: false, msg: "è«‹åœ¨äº‹ä»¶å…§å‘¼å«å‡½æ•¸ï¼"};
                    return {pass: true, actions: [{type: 'fix', index: 0}]};
                }
            },
            {
                id: 3, title: "L3: è¿´åœˆè™•ç†",
                desc: "ä»»å‹™ï¼šæœ‰ 3 å°ä¼ºæœå™¨å£äº†ï¼ä½¿ç”¨ <span class='tag'>é‡è¤‡ 3 æ¬¡</span> ä¾†ä¿®å¾©å®ƒå€‘ã€‚",
                targets: [{type: 'server', status: 'broken'}, {type: 'server', status: 'broken'}, {type: 'server', status: 'broken'}],
                blocks: [{type: 'event', text: 'ç•¶æŒ‰éˆ• A è¢«æŒ‰ä¸‹', isContainer: true}, {type: 'loop', text: 'é‡è¤‡ 3 æ¬¡', isContainer: true}, {type: 'call', text: 'å‘¼å«: ä¿®å¾©'}],
                preset: [{type: 'func', text: 'å‡½æ•¸: ä¿®å¾©', isContainer: true, children: [{type: 'action', text: 'å‹•ä½œ: ç™¼å°„å…‰æŸ'}]}],
                check: (ws) => {
                    const loop = ws.querySelector('.block-loop');
                    if(!loop || !loop.querySelector('.block-call')) return {pass: false, msg: "è¨˜å¾—æŠŠå‘¼å«æ”¾å…¥è¿´åœˆä¸­ï¼"};
                    return {pass: true, actions: [{type: 'fix', index: 0}, {type: 'fix', index: 1}, {type: 'fix', index: 2}]};
                }
            },
            {
                id: 4, title: "L4: é™¤éŒ¯ (Debug)",
                desc: "âš ï¸ <b>ç¨‹å¼æœ‰Bugï¼</b><br>æ©Ÿå™¨äººåªä¿®å¾©äº† 1 å°ï¼Œä½†æœ‰ 3 å°ã€‚è«‹ä¿®æ­£å·¥ä½œå€çš„ç¨‹å¼ç¢¼ï¼",
                targets: [{type: 'server', status: 'broken'}, {type: 'server', status: 'broken'}, {type: 'server', status: 'broken'}],
                blocks: [{type: 'loop', text: 'é‡è¤‡ 3 æ¬¡', isContainer: true}, {type: 'call', text: 'å‘¼å«: ä¿®å¾©'}],
                preset: [
                    {type: 'func', text: 'å‡½æ•¸: ä¿®å¾©', isContainer: true, children: [{type: 'action', text: 'å‹•ä½œ: ç™¼å°„å…‰æŸ'}]},
                    {type: 'event', text: 'ç•¶æŒ‰éˆ• A è¢«æŒ‰ä¸‹', isContainer: true, children: [{type: 'call', text: 'å‘¼å«: ä¿®å¾©'}]}
                ],
                check: (ws) => {
                    const loop = ws.querySelector('.block-loop');
                    if(!loop) return {pass: false, msg: "éœ€è¦ä½¿ç”¨ã€Œé‡è¤‡ã€ç©æœ¨ï¼"};
                    if(!loop.querySelector('.block-call')) return {pass: false, msg: "è¿´åœˆè¦æ˜¯ç©ºçš„å°±æ²’ç”¨å›‰ï¼"};
                    return {pass: true, actions: [{type: 'fix', index: 0}, {type: 'fix', index: 1}, {type: 'fix', index: 2}]};
                }
            },
            {
                id: 5, title: "L5: é‚è¼¯åˆ¤æ–·",
                desc: "ä»»å‹™ï¼šåªæœ‰ <span class='tag'>å£æ‰</span> çš„æ‰ä¿®ï¼ç´…è‰²éç†±çš„ä¸è¦ç¢°ã€‚",
                targets: [{type: 'server', status: 'broken'}, {type: 'server', status: 'red-alert'}, {type: 'server', status: 'broken'}],
                blocks: [{type: 'event', text: 'ç•¶æŒ‰éˆ• A è¢«æŒ‰ä¸‹', isContainer: true}, {type: 'loop', text: 'é‡è¤‡ 3 æ¬¡', isContainer: true}, {type: 'logic', text: 'å¦‚æœ <ä¼ºæœå™¨å£æ‰> å‰‡', isContainer: true}, {type: 'call', text: 'å‘¼å«: ä¿®å¾©'}, {type: 'action', text: 'å‹•ä½œ: æƒæ'}],
                preset: [{type: 'func', text: 'å‡½æ•¸: ä¿®å¾©', isContainer: true, children: [{type: 'action', text: 'å‹•ä½œ: ç™¼å°„å…‰æŸ'}]}],
                check: (ws) => {
                    const logic = ws.querySelector('.block-logic');
                    if(!logic) return {pass: false, msg: "è«‹ä½¿ç”¨ã€Œå¦‚æœã€ä¾†åˆ¤æ–·ï¼"};
                    if(!logic.querySelector('.block-call')) return {pass: false, msg: "å¦‚æœå£æ‰ï¼Œè¦åŸ·è¡Œä»€éº¼ï¼Ÿ"};
                    
                    let acts = [];
                    [0, 1, 2].forEach(i => {
                        acts.push({type: 'scan', index: i});
                        if(gameLevels[4].targets[i].status === 'broken') acts.push({type: 'fix', index: i});
                    });
                    return {pass: true, actions: acts};
                }
            },
            {
                id: 6, title: "L6: è¤‡åˆæŒ‘æˆ° (Hard)",
                desc: "âš ï¸ <b>é‡åˆ°ç›¾ç‰Œ->ç ´è§£ï¼Œé‡åˆ°å£æ‰->ä¿®å¾©ï¼Œæ­£å¸¸->æƒæ</b>ã€‚",
                targets: [{type: 'shield', status: 'shield'}, {type: 'server', status: 'broken'}, {type: 'server', status: 'normal'}],
                blocks: [
                    {type: 'func', text: 'å‡½æ•¸: ç ´è§£', isContainer: true}, {type: 'action', text: 'å‹•ä½œ: ç ´è§£å…‰æŸ'},
                    {type: 'event', text: 'ç•¶æŒ‰éˆ• A è¢«æŒ‰ä¸‹', isContainer: true}, {type: 'loop', text: 'é‡è¤‡ 3 æ¬¡', isContainer: true}, 
                    {type: 'logic', text: 'å¦‚æœ <é‡åˆ°ç›¾ç‰Œ> å‰‡ / å¦å‰‡', isContainer: true, hasElse: true}, {type: 'logic', text: 'å¦‚æœ <ä¼ºæœå™¨å£æ‰> å‰‡', isContainer: true}, 
                    {type: 'call', text: 'å‘¼å«: ç ´è§£'}, {type: 'call', text: 'å‘¼å«: ä¿®å¾©'}, {type: 'action', text: 'å‹•ä½œ: æƒæ'}
                ],
                preset: [{type: 'func', text: 'å‡½æ•¸: ä¿®å¾©', isContainer: true, children: [{type: 'action', text: 'å‹•ä½œ: ç™¼å°„å…‰æŸ'}]}],
                check: (ws) => {
                    const text = ws.innerText;
                    if(!text.includes('å¦‚æœ <é‡åˆ°ç›¾ç‰Œ>')) return {pass: false, msg: "ç¼ºå°‘ç›¾ç‰Œåˆ¤æ–·"};
                    if(!text.includes('ç ´è§£')) return {pass: false, msg: "æ²’æœ‰åŸ·è¡Œç ´è§£"};
                    if(!text.includes('ä¿®å¾©')) return {pass: false, msg: "æ²’æœ‰åŸ·è¡Œä¿®å¾©"};
                    return {pass: true, actions: [{type: 'hack', index: 0}, {type: 'fix', index: 1}, {type: 'scan', index: 2}]};
                }
            },
            {
                id: 7, title: "L7: é‚è¼¯å…¨éŒ¯äº† (Expert)",
                desc: "â˜ ï¸ <b>é‚è¼¯å…¨éŒ¯äº†ï¼</b><br>é‡åˆ°ç›¾ç‰Œå»åœ¨ä¿®å¾©ï¼Ÿå£æ‰å»åœ¨ç ´è§£ï¼Ÿè«‹ä¿®æ­£æ‰€æœ‰éŒ¯èª¤ï¼",
                targets: [{type: 'shield', status: 'shield'}, {type: 'server', status: 'broken'}],
                blocks: [{type: 'call', text: 'å‘¼å«: ç ´è§£'}, {type: 'call', text: 'å‘¼å«: ä¿®å¾©'}],
                preset: [
                    {type: 'func', text: 'å‡½æ•¸: ä¿®å¾©', isContainer: true, children: [{type: 'action', text: 'å‹•ä½œ: ç™¼å°„å…‰æŸ'}]},
                    {type: 'func', text: 'å‡½æ•¸: ç ´è§£', isContainer: true, children: [{type: 'action', text: 'å‹•ä½œ: ç ´è§£å…‰æŸ'}]},
                    {type: 'event', text: 'æŒ‰éˆ• A', isContainer: true, children: [
                        {type: 'loop', text: 'é‡è¤‡ 2 æ¬¡', isContainer: true, children: [
                             {type: 'logic', text: 'å¦‚æœ <ç›¾ç‰Œ> / å¦å‰‡', isContainer: true, hasElse: true, children: [
                                 {type: 'call', text: 'å‘¼å«: ä¿®å¾©'}, 
                                 {type: 'call', text: 'å‘¼å«: ç ´è§£'}  
                             ]}
                        ]}
                    ]}
                ],
                check: (ws) => {
                    const slot1 = ws.querySelector('.block-logic .game-slot:nth-child(2)'); // If slot
                    if(slot1 && slot1.innerText.includes('ä¿®å¾©')) return {pass: false, msg: "é‡åˆ°ç›¾ç‰Œä¸èƒ½ä¿®å¾©ï¼"};
                    return {pass: true, actions: [{type: 'hack', index: 0}, {type: 'fix', index: 1}]};
                }
            }
        ];

        let currentGameLevelIdx = 0;

        function initGame() {
            loadGameLevel(currentGameLevelIdx);
            
            const ws = document.getElementById('workspace');
            if(ws) {
                ws.addEventListener('dragover', e => e.preventDefault());
                ws.addEventListener('drop', (e) => handleGameDrop(e, ws));
            }
        }

        function loadGameLevel(idx) {
            playSound('click');
            currentGameLevelIdx = idx;
            const lvl = gameLevels[idx];
            
            document.getElementById('game-level-display').innerText = lvl.title;
            document.getElementById('mission-text').innerHTML = lvl.desc;
            document.getElementById('game-msg-box').innerText = "æº–å‚™å°±ç·’";
            document.getElementById('game-msg-box').style.color = "#64748b";
            document.getElementById('btn-next-level').style.display = 'none';
            document.querySelector('.btn-run').disabled = false;

            const toolbox = document.getElementById('toolbox');
            toolbox.innerHTML = '';
            lvl.blocks.forEach(b => createGameBlock(b, toolbox));

            const ws = document.getElementById('workspace');
            ws.innerHTML = '';
            
            if(lvl.preset && lvl.preset.length > 0) {
                lvl.preset.forEach(b => {
                    const el = createGameBlock(b, null, true);
                    ws.appendChild(el);
                });
            } else {
                 ws.innerHTML = '<div id="empty-hint" class="text-center text-slate-300 mt-20 pointer-events-none select-none text-sm">â˜Ÿ æ‹–æ”¾ç©æœ¨åˆ°é€™è£¡</div>';
            }

            setupGameStage(lvl);
        }

        function setupGameStage(lvl) {
            document.querySelectorAll('.target-svg').forEach(e => e.remove());
            const canvas = document.getElementById('canvas');
            
            const canvasWidth = canvas.clientWidth || 400; 
            const safeArea = canvasWidth - 100; 
            
            let step = safeArea / lvl.targets.length;
            if (step > 120) step = 120;
            if (step < 70) step = 70;

            lvl.targets.forEach((t, i) => {
                const div = document.createElement('div');
                div.className = `sprite target-svg ${t.status}`;
                div.innerHTML = gameSVGs[t.type] || gameSVGs.server;
                div.style.left = (80 + i * step) + 'px'; 
                div.style.bottom = "60px";
                div.dataset.index = i;
                canvas.appendChild(div);
            });

            const robot = document.getElementById('robot');
            robot.style.left = "20px";
            robot.style.top = "320px"; // Reset vertical pos
        }

        function createGameBlock(data, container, returnEl = false) {
            const el = document.createElement('div');
            el.className = `game-block block-${data.type}`;
            el.draggable = true;
            el.dataset.json = JSON.stringify(data);

            const header = document.createElement('div');
            header.className = 'block-header';
            header.innerText = data.text;
            el.appendChild(header);

            el.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('json', JSON.stringify(data));
                e.dataTransfer.effectAllowed = 'copy';
                e.stopPropagation();
                playSound('click');
            });

            el.addEventListener('dblclick', (e) => {
                if(el.closest('#workspace')) {
                    el.remove();
                    playSound('click');
                    e.stopPropagation();
                    if(document.getElementById('workspace').children.length === 0) {
                         document.getElementById('workspace').innerHTML = '<div id="empty-hint" class="text-center text-slate-300 mt-20 pointer-events-none select-none text-sm">â˜Ÿ æ‹–æ”¾ç©æœ¨åˆ°é€™è£¡</div>';
                    }
                }
            });

            if(data.isContainer) {
                const slot = createSlot();
                el.appendChild(slot);
                
                if(data.children) {
                    data.children.forEach(child => {
                        const childEl = createGameBlock(child, null, true);
                        slot.appendChild(childEl);
                    });
                }

                if(data.hasElse) {
                    const elseText = document.createElement('div');
                    elseText.innerText = "å¦å‰‡";
                    elseText.className = "text-xs opacity-80 px-1 mt-1 font-normal";
                    el.appendChild(elseText);
                    const slot2 = createSlot();
                    el.appendChild(slot2);
                    
                    if(data.children && data.children[1]) {
                        const childEl = createGameBlock(data.children[1], null, true);
                        slot2.appendChild(childEl);
                    }
                }
            }

            if(returnEl) return el;
            if(container) container.appendChild(el);
        }

        function createSlot() {
            const slot = document.createElement('div');
            slot.className = 'game-slot';
            slot.addEventListener('dragover', e => { 
                if(!slot.closest('#workspace')) return; 
                e.preventDefault(); e.stopPropagation(); 
                slot.classList.add('drag-over'); 
            });
            slot.addEventListener('dragleave', e => { 
                e.preventDefault(); e.stopPropagation(); 
                slot.classList.remove('drag-over'); 
            });
            slot.addEventListener('drop', e => handleGameDrop(e, slot));
            return slot;
        }

        function handleGameDrop(e, targetContainer) {
            e.preventDefault(); e.stopPropagation();
            targetContainer.classList.remove('drag-over');
            
            if(!targetContainer.closest('#workspace')) return;

            playSound('click');

            const json = e.dataTransfer.getData('json');
            if(!json) return;
            const data = JSON.parse(json);

            const hint = document.getElementById('empty-hint');
            if(hint) hint.remove();

            const newBlock = createGameBlock(data, null, true);
            targetContainer.appendChild(newBlock);
        }

        async function runGameCode() {
            playSound('click');
            const lvl = gameLevels[currentGameLevelIdx];
            const ws = document.getElementById('workspace');
            const res = lvl.check(ws);
            const msg = document.getElementById('game-msg-box');

            if(!res.pass) {
                playSound('fail');
                msg.innerText = "âŒ " + res.msg;
                msg.style.color = "#ef4444";
                ws.animate([{transform: 'translateX(0)'}, {transform: 'translateX(-5px)'}, {transform: 'translateX(5px)'}, {transform: 'translateX(0)'}], {duration: 300});
                return;
            }

            msg.innerText = "âš¡ åŸ·è¡Œä¸­...";
            msg.style.color = "#22c55e";
            document.querySelector('.btn-run').disabled = true;
            await executeGameActions(res.actions);
        }

        async function executeGameActions(actions) {
            const robot = document.getElementById('robot');
            const beam = document.getElementById('beam');
            const canvas = document.getElementById('canvas');
            
            for(let action of actions) {
                const targetEl = document.querySelector(`.target-svg[data-index='${action.index}']`);
                if(!targetEl) continue;

                const targetX = targetEl.offsetLeft - 30; 
                robot.style.left = targetX + 'px';
                await wait(800);

                if(action.type === 'fix' || action.type === 'hack') {
                    playSound('laser');
                    
                    const robotRect = robot.getBoundingClientRect();
                    const targetRect = targetEl.getBoundingClientRect();
                    const canvasRect = canvas.getBoundingClientRect();

                    const startX = (robotRect.left - canvasRect.left) + (robotRect.width / 2) + 10;
                    const startY = (robotRect.top - canvasRect.top) + (robotRect.height / 2);
                    
                    const endX = (targetRect.left - canvasRect.left) + (targetRect.width / 2);
                    const endY = (targetRect.top - canvasRect.top) + (targetRect.height / 2);

                    beam.style.left = startX + 'px';
                    beam.style.top = startY + 'px';
                    
                    const width = Math.hypot(endX - startX, endY - startY);
                    const angle = Math.atan2(endY - startY, endX - startX) * 180 / Math.PI;

                    beam.style.width = width + 'px';
                    beam.style.transform = `rotate(${angle}deg)`;
                    
                    const color = action.type === 'hack' ? '#f59e0b' : '#22c55e';
                    beam.style.background = color;
                    beam.style.boxShadow = `0 0 10px ${color}`;
                    beam.style.opacity = 1;

                    targetEl.classList.add('shake');
                    await wait(500);

                    beam.style.opacity = 0;
                    targetEl.classList.remove('shake');
                    
                    if(action.type === 'fix') {
                        targetEl.classList.remove('broken');
                        targetEl.classList.add('fixed');
                    }
                    if(action.type === 'hack') {
                        targetEl.style.opacity = 0.3;
                    }

                } else if(action.type === 'scan') {
                    robot.style.filter = "brightness(1.5) drop-shadow(0 0 10px blue)";
                    await wait(300);
                    robot.style.filter = "none";
                }
                await wait(400);
            }

            playSound('success');
            document.getElementById('game-msg-box').innerText = "ğŸ† ä»»å‹™å®Œæˆï¼";
            document.getElementById('btn-next-level').style.display = 'flex';
        }

        function nextGameLevel() {
            if(currentGameLevelIdx < gameLevels.length - 1) loadGameLevel(currentGameLevelIdx + 1);
            else alert("æ­å–œé€šé—œï¼ä½ æ˜¯é‚è¼¯å¤§å¸«ï¼");
        }
        function wait(ms) { return new Promise(r => setTimeout(r, ms)); }

        window.onload = init;
    </script>
</body>
</html>
