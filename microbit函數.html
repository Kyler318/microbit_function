<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Micro:bit å‡½æ•¸å¤§å†’éšª v2.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://bernardo-castilho.github.io/DragDropTouch/DragDropTouch.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Consolas&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f0f9ff;
            touch-action: none; /* é˜²æ­¢æ‰‹æ©Ÿä¸Šä¸‹æ»‘å‹•å¹²æ“¾æ‹–æ›³ */
        }

        /* --- åŸæœ‰æ•™å­¸æ¨£å¼ --- */
        .step-active {
            border-bottom: 3px solid #3B82F6;
            color: #1D4ED8;
            font-weight: bold;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- éŠæˆ²å°ˆç”¨æ¨£å¼ (Game CSS) --- */
        :root {
            --block-event: #993399; 
            --block-func: #1b2c45;  
            --block-call: #2c3e50;  
            --block-loop: #00b848;  
            --block-logic: #00a4a6; 
            --block-action: #d35400;
        }

        .game-block {
            padding: 8px 12px; /* åŠ å¤§ä¸€é»æ–¹ä¾¿è§¸æ§ */
            margin: 4px 0;
            color: white;
            font-family: 'Consolas', monospace;
            font-size: 14px;
            border-radius: 6px;
            cursor: grab;
            display: inline-block;
            box-shadow: 2px 2px 0 rgba(0,0,0,0.2);
            position: relative;
            border: 1px solid rgba(255,255,255,0.3);
            user-select: none;
            z-index: 10;
            touch-action: none;
        }
        .game-block:active { transform: scale(0.98); cursor: grabbing; }

        .block-event { background: var(--block-event); border-radius: 12px 12px 4px 4px; display:block; width: fit-content; margin-top: 10px;}
        .block-func { background: var(--block-func); display:block; width: fit-content; margin-bottom: 8px;}
        .block-call { background: var(--block-call); }
        .block-loop { background: var(--block-loop); border-radius: 4px 12px 4px 4px; display:block; width: fit-content;}
        .block-logic { background: var(--block-logic); border-radius: 4px; display:block; width: fit-content; }
        .block-action { background: var(--block-action); }

        .game-slot {
            background: rgba(0,0,0,0.08);
            min-height: 44px; /* åŠ é«˜è®“æ‰‹æŒ‡å®¹æ˜“æ”¾å…¥ */
            margin: 4px 0 4px 8px;
            border-left: 3px solid rgba(0,0,0,0.1);
            border-radius: 6px;
            padding: 8px 6px;
            min-width: 140px;
            transition: all 0.2s;
        }
        
        /* æ‹–æ›³æ™‚çš„æ„Ÿæ‡‰æ¨£å¼ */
        .game-slot.drag-over {
            background: #bbf7d0; 
            border: 2px dashed #16a34a;
            transform: scale(1.02);
        }

        .tag { display: inline-block; background: #eceff1; padding: 2px 6px; border-radius: 4px; font-family: monospace; font-weight: bold; color: #455a64; border: 1px solid #cfd8dc; font-size: 0.85em; }

        /* Game Sprites */
        .sprite { position: absolute; transition: left 0.5s ease, top 0.5s ease; }
        .robot-svg { width: 80px; height: 80px; z-index: 20; transition: all 0.3s; }
        .target-svg { width: 60px; height: 60px; z-index: 10; bottom: 50px; transition: all 0.3s; }
        
        .target-svg.broken { filter: grayscale(100%) brightness(0.8); }
        .target-svg.red-alert { filter: sepia(100%) hue-rotate(-50deg) saturate(300%); }
        .target-svg.fixed { filter: grayscale(0%) drop-shadow(0 0 10px #00e676); transform: scale(1.1); }
        .target-svg.shield { filter: drop-shadow(0 0 5px #0277bd); }

        .beam {
            position: absolute; height: 6px; background: #00e676;
            border-radius: 4px; z-index: 15; opacity: 0;
            transform-origin: left center;
            box-shadow: 0 0 15px #00e676;
            pointer-events: none;
        }

        .particle {
            position: absolute; width: 6px; height: 6px; border-radius: 50%;
            pointer-events: none; z-index: 30;
        }

        .shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-2px, 0, 0); }
            20%, 80% { transform: translate3d(4px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-6px, 0, 0); }
            40%, 60% { transform: translate3d(6px, 0, 0); }
        }

        /* Tutorial specific overrides */
        .code-block-demo {
            padding: 4px 8px; border-radius: 4px; color: white; font-weight: bold; font-family: monospace; display: inline-block;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen text-slate-800">

    <nav class="bg-white shadow-md p-4 sticky top-0 z-50">
        <div class="max-w-5xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2">
                <i data-lucide="cpu" class="text-blue-600"></i>
                <h1 class="text-xl font-bold text-slate-800">Micro:bit å‡½æ•¸é­”æ³•æ•™å®¤</h1>
            </div>
            <div class="text-sm text-slate-500 hidden md:block">äº’å‹•å¼æ•™å­¸ç³»çµ± v2.1</div>
        </div>
    </nav>

    <main class="flex-grow p-4 md:p-8 max-w-5xl mx-auto w-full">
        
        <div class="flex justify-between mb-8 overflow-x-auto pb-2" id="progressBar">
            </div>

        <div id="contentArea" class="bg-white rounded-2xl shadow-xl p-6 md:p-10 min-h-[600px] relative fade-in">
            </div>

        <div class="flex justify-between mt-6 max-w-5xl mx-auto">
            <button id="prevBtn" onclick="changeStep(-1)" class="px-6 py-2 bg-slate-200 hover:bg-slate-300 rounded-lg font-semibold text-slate-700 transition disabled:opacity-50 disabled:cursor-not-allowed">
                <i data-lucide="arrow-left" class="inline w-4 h-4 mb-1"></i> ä¸Šä¸€æ­¥
            </button>
            <button id="nextBtn" onclick="changeStep(1)" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg font-semibold text-white transition disabled:opacity-50 disabled:cursor-not-allowed">
                ä¸‹ä¸€æ­¥ <i data-lucide="arrow-right" class="inline w-4 h-4 mb-1"></i>
            </button>
        </div>
    </main>

    <footer class="bg-slate-100 py-6 text-center text-slate-500 text-sm mt-8">
        <p>Micro:bit å‡½æ•¸æ•™å­¸å–®å…ƒ | Designed for Education</p>
    </footer>

    <script>
        // --- ç°¡æ˜“éŸ³æ•ˆåˆæˆå™¨ ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function playSound(type) {
            // ç”¨æˆ¶äº’å‹•å¾Œæ‰èƒ½æ¢å¾© AudioContext
            if (audioCtx.state === 'suspended') audioCtx.resume();
            
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);

            const now = audioCtx.currentTime;
            
            if (type === 'success') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(587, now); // D5
                osc.frequency.setValueAtTime(1175, now + 0.1); // D6
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                osc.start(now);
                osc.stop(now + 0.3);
            } else if (type === 'fail') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, now);
                osc.frequency.linearRampToValueAtTime(100, now + 0.3);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.linearRampToValueAtTime(0.01, now + 0.3);
                osc.start(now);
                osc.stop(now + 0.3);
            } else if (type === 'click') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(800, now);
                gain.gain.setValueAtTime(0.05, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.05);
                osc.start(now);
                osc.stop(now + 0.05);
            } else if (type === 'laser') {
                osc.type = 'square';
                osc.frequency.setValueAtTime(800, now);
                osc.frequency.exponentialRampToValueAtTime(100, now + 0.2);
                gain.gain.setValueAtTime(0.05, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
                osc.start(now);
                osc.stop(now + 0.2);
            }
        }

        // --- Data & Content ---
        const tutorialSteps = [
            {
                id: "intro",
                title: "1. ç‚ºä»€éº¼è¦å­¸å‡½æ•¸ï¼Ÿ",
                icon: "help-circle",
                render: () => `
                    <div class="space-y-6 text-center">
                        <h2 class="text-3xl font-bold text-blue-700">ä½ æœ‰é‡éé€™ç¨®éº»ç…©å—ï¼Ÿ</h2>
                        <p class="text-lg text-slate-600">æƒ³åƒä¸€ä¸‹ï¼Œä½ è¦è®“ Micro:bit é–ƒçˆæ„›å¿ƒä¸‰æ¬¡ï¼Œä½ æœƒæ€éº¼å¯«ç¨‹å¼ï¼Ÿ</p>
                        
                        <div class="grid md:grid-cols-2 gap-8 items-center mt-8">
                            <div class="bg-red-50 p-4 rounded-xl border-2 border-red-200">
                                <h3 class="font-bold text-red-600 mb-2">âŒ æ²’ç”¨å‡½æ•¸ (ç´¯æ­»äººå¯«æ³•)</h3>
                                <div class="text-left text-xs space-y-1 opacity-70">
                                    <div class="code-block-demo bg-emerald-500">é¡¯ç¤ºåœ–ç¤º â¤ï¸</div>
                                    <div class="code-block-demo bg-emerald-500">æš«åœ 500ms</div>
                                    <div class="code-block-demo bg-emerald-500">æ¸…ç©ºè¢å¹•</div>
                                    <div class="code-block-demo bg-emerald-500">æš«åœ 500ms</div>
                                    <div class="code-block-demo bg-emerald-500">é¡¯ç¤ºåœ–ç¤º â¤ï¸</div>
                                    <div class="code-block-demo bg-emerald-500">...é‚„æœ‰å¥½å¤šè¡Œ</div>
                                </div>
                                <p class="mt-4 text-sm text-red-500">ç¨‹å¼ç¢¼è¶…é•·ï¼Œå¦‚æœè¦æ”¹æ™‚é–“ï¼Œæ¯ä¸€è¡Œéƒ½è¦æ”¹ï¼</p>
                            </div>

                            <div class="bg-green-50 p-4 rounded-xl border-2 border-green-200">
                                <h3 class="font-bold text-green-600 mb-2">âœ… ä½¿ç”¨å‡½æ•¸ (è°æ˜å¯«æ³•)</h3>
                                <div class="text-left text-xs space-y-1">
                                    <div class="code-block-demo bg-blue-800">å»ºç«‹å‡½æ•¸ "é–ƒçˆæ„›å¿ƒ"</div>
                                    <div class="ml-4 p-2 bg-blue-100 rounded">
                                         <div class="code-block-demo bg-emerald-500">é¡¯ç¤ºåœ–ç¤º â¤ï¸</div>
                                         <div class="code-block-demo bg-emerald-500">æš«åœ 500ms</div>
                                         <div class="code-block-demo bg-emerald-500">æ¸…ç©ºè¢å¹•</div>
                                    </div>
                                    <div class="mt-4 code-block-demo bg-green-500">é‡è¤‡ 3 æ¬¡</div>
                                    <div class="ml-4 p-2 bg-green-100 rounded">
                                        <div class="code-block-demo bg-blue-800">å‘¼å« "é–ƒçˆæ„›å¿ƒ"</div>
                                    </div>
                                </div>
                                <p class="mt-4 text-sm text-green-600">å®šç¾©ä¸€æ¬¡ï¼Œéš¨æ™‚å‘¼å«ï¼ç¨‹å¼ç¢¼ä¹¾æ·¨åˆå¥½æ”¹ã€‚</p>
                            </div>
                        </div>
                    </div>
                `
            },
            {
                id: "concept",
                title: "2. å‡½æ•¸æ˜¯ä»€éº¼ï¼Ÿ",
                icon: "book-open",
                render: () => `
                    <div class="space-y-6">
                        <h2 class="text-2xl font-bold text-slate-800 flex items-center gap-2">
                            <i data-lucide="package" class="text-purple-500"></i> å‡½æ•¸ (Function) çš„æ¦‚å¿µ
                        </h2>
                        
                        <div class="bg-blue-50 p-6 rounded-xl border-l-4 border-blue-500">
                            <p class="text-lg leading-relaxed">
                                <strong>å‡½æ•¸</strong>å°±åƒæ˜¯ä¸€å€‹<strong>ã€Œæ‰“åŒ…å¥½çš„é­”æ³•ç®±å­ã€</strong>ã€‚
                                <br>ä½ æŠŠä¸€å †æŒ‡ä»¤æ”¾é€²ç®±å­è£¡ï¼Œçµ¦ç®±å­è²¼ä¸Šä¸€å€‹æ¨™ç±¤ï¼ˆåå­—ï¼‰ã€‚
                                <br>ä¹‹å¾Œåªè¦å«é€™å€‹åå­—ï¼Œç®±å­è£¡çš„æŒ‡ä»¤å°±æœƒè‡ªå‹•åŸ·è¡Œï¼
                            </p>
                        </div>

                        <div class="grid md:grid-cols-2 gap-6 mt-6">
                            <div class="bg-white border rounded-lg p-4 shadow-sm">
                                <h3 class="font-bold text-lg mb-2">ç‰¹é» 1ï¼šæ‰“åŒ…æŒ‡ä»¤</h3>
                                <p class="text-slate-600">å°‡è¤‡é›œçš„å‹•ä½œï¼ˆå¦‚ï¼šå‰é€²ã€å·¦è½‰ã€è·³èºï¼‰çµ„åˆæˆä¸€å€‹æ–°å‹•ä½œï¼ˆå¦‚ï¼šå¤§çµ•æ‹›ï¼‰ã€‚</p>
                            </div>
                            <div class="bg-white border rounded-lg p-4 shadow-sm">
                                <h3 class="font-bold text-lg mb-2">ç‰¹é» 2ï¼šé‡è¤‡ä½¿ç”¨</h3>
                                <p class="text-slate-600">å¯«å¥½ä¸€æ¬¡ï¼Œå¯ä»¥åœ¨ç¨‹å¼çš„ä»»ä½•åœ°æ–¹å‘¼å«å®ƒ 100 æ¬¡ï¼Œä¸ç”¨é‡å¯«ã€‚</p>
                            </div>
                            <div class="bg-white border rounded-lg p-4 shadow-sm">
                                <h3 class="font-bold text-lg mb-2">ç‰¹é» 3ï¼šå®¹æ˜“ä¿®æ”¹</h3>
                                <p class="text-slate-600">å¦‚æœè¦ä¿®æ”¹å‹•ä½œï¼Œåªè¦æ”¹å‡½æ•¸è£¡é¢çš„å…§å®¹ï¼Œæ‰€æœ‰å‘¼å«çš„åœ°æ–¹éƒ½æœƒè‡ªå‹•æ›´æ–°ã€‚</p>
                            </div>
                        </div>
                    </div>
                `
            },
            {
                id: "flow",
                title: "3. é‹ä½œæµç¨‹",
                icon: "activity",
                render: () => `
                     <div class="space-y-6">
                        <h2 class="text-2xl font-bold text-slate-800">ç¨‹å¼æ˜¯æ€éº¼è·‘çš„ï¼Ÿ</h2>
                        <p class="text-slate-600">ç•¶ä¸»ç¨‹å¼é‡åˆ°ã€Œå‘¼å«å‡½æ•¸ã€ç©æœ¨æ™‚ï¼Œæœƒæš«æ™‚è·³å»åŸ·è¡Œå‡½æ•¸å…§çš„å…§å®¹ï¼Œåšå®Œå†å›ä¾†ã€‚</p>

                        <div class="bg-slate-800 p-6 rounded-xl text-white relative overflow-hidden">
                            <div class="grid grid-cols-2 gap-8">
                                <div class="border border-slate-600 p-4 rounded bg-slate-700/50" id="mainProgramArea">
                                    <h4 class="text-sm text-slate-400 mb-2">ç•¶å•Ÿå‹•æ™‚ (ä¸»ç¨‹å¼)</h4>
                                    <div id="step1" class="code-block-demo bg-green-500 w-full mb-2 opacity-30">1. é¡¯ç¤ºæ–‡å­— "Start"</div>
                                    <div id="step2" class="code-block-demo bg-blue-900 w-full mb-2 opacity-30">2. å‘¼å«å‡½æ•¸ "ç¬‘è‡‰"</div>
                                    <div id="step4" class="code-block-demo bg-green-500 w-full opacity-30">3. é¡¯ç¤ºæ–‡å­— "End"</div>
                                </div>

                                <div class="border border-slate-600 p-4 rounded bg-slate-700/50" id="funcDefArea">
                                    <h4 class="text-sm text-slate-400 mb-2">å‡½æ•¸ "ç¬‘è‡‰"</h4>
                                    <div class="p-2 border border-dashed border-blue-400 rounded">
                                        <div id="step3a" class="code-block-demo bg-emerald-500 w-full mb-2 opacity-30">LED é¡¯ç¤º :)</div>
                                        <div id="step3b" class="code-block-demo bg-emerald-500 w-full opacity-30">æ’­æ”¾éŸ³æ•ˆ BEEP</div>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-6 flex items-center justify-between bg-slate-900 p-3 rounded-lg">
                                <div id="flowStatus" class="text-yellow-400 font-mono">æº–å‚™åŸ·è¡Œ...</div>
                                <button onclick="runFlowSimulation()" class="px-4 py-2 bg-green-600 hover:bg-green-500 rounded font-bold flex items-center gap-2">
                                    <i data-lucide="play"></i> åŸ·è¡Œæµç¨‹
                                </button>
                            </div>
                        </div>
                    </div>
                `
            },
            {
                id: "life",
                title: "4. ç”Ÿæ´»ä¸­çš„æ‡‰ç”¨",
                icon: "coffee",
                render: () => `
                    <div class="space-y-6">
                        <h2 class="text-2xl font-bold text-slate-800">ç”Ÿæ´»ä¸­çš„å‡½æ•¸ç„¡è™•ä¸åœ¨</h2>
                        <p class="text-slate-600">å…¶å¯¦æˆ‘å€‘ç”Ÿæ´»ä¸­æ—©å°±ç¿’æ…£ä½¿ç”¨ã€Œå‡½æ•¸ã€çš„æ¦‚å¿µäº†ï¼Œåªæ˜¯æˆ‘å€‘æ²’ç™¼ç¾ï¼</p>

                        <div class="grid md:grid-cols-3 gap-6 mt-4">
                            <div class="bg-white rounded-xl shadow-lg overflow-hidden transform hover:-translate-y-1 transition duration-300">
                                <div class="bg-indigo-100 p-6 flex justify-center">
                                    <i data-lucide="music" class="w-16 h-16 text-indigo-500"></i>
                                </div>
                                <div class="p-6">
                                    <h3 class="font-bold text-lg mb-2">æµè¡Œæ­Œæ›²çš„ã€Œå‰¯æ­Œã€</h3>
                                    <p class="text-sm text-slate-600">
                                        ä½œæ›²å®¶ä¸æœƒæŠŠå‰¯æ­Œçš„æ­Œè©å’Œæ—‹å¾‹é‡å¯«ä¸‰éã€‚ä»–å€‘æœƒå¯«ä¸€æ¬¡å‰¯æ­Œæ®µè½ï¼Œç„¶å¾Œåœ¨æ¨‚è­œä¸Šæ¨™è¨˜ã€Œå›åˆ°å‰¯æ­Œ (Chorus)ã€ã€‚
                                    </p>
                                    <div class="mt-4 text-xs font-mono bg-slate-100 p-2 rounded text-slate-500">
                                        ä¸»æ­Œ1 -> <span class="text-blue-600 font-bold">å‘¼å«å‰¯æ­Œ</span> -> ä¸»æ­Œ2 -> <span class="text-blue-600 font-bold">å‘¼å«å‰¯æ­Œ</span>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-white rounded-xl shadow-lg overflow-hidden transform hover:-translate-y-1 transition duration-300">
                                <div class="bg-sky-100 p-6 flex justify-center">
                                    <i data-lucide="shirt" class="w-16 h-16 text-sky-500"></i>
                                </div>
                                <div class="p-6">
                                    <h3 class="font-bold text-lg mb-2">æ´—è¡£æ©Ÿçš„ã€Œå¿«æ´—æ¨¡å¼ã€</h3>
                                    <p class="text-sm text-slate-600">
                                        ä½ ä¸ç”¨æ¯æ¬¡éƒ½æ‰‹å‹•è¨­å®šï¼šæ”¾æ°´->è½‰å‹•5åˆ†->æ’æ°´->è„«æ°´ã€‚
                                        ä½ åªéœ€è¦æŒ‰ä¸‹ä¸€é¡†æŒ‰éˆ•ï¼ˆå‘¼å«å‡½æ•¸ï¼‰ï¼Œæ´—è¡£æ©Ÿå°±æœƒè‡ªå‹•åŸ·è¡Œé‚£ä¸€æ•´å¥—è¨­å®šå¥½çš„æµç¨‹ã€‚
                                    </p>
                                </div>
                            </div>

                            <div class="bg-white rounded-xl shadow-lg overflow-hidden transform hover:-translate-y-1 transition duration-300">
                                <div class="bg-orange-100 p-6 flex justify-center">
                                    <i data-lucide="utensils" class="w-16 h-16 text-orange-500"></i>
                                </div>
                                <div class="p-6">
                                    <h3 class="font-bold text-lg mb-2">é€Ÿé£Ÿåº—ã€Œ1è™Ÿé¤ã€</h3>
                                    <p class="text-sm text-slate-600">
                                        ä½ è·Ÿåº—å“¡èªªã€Œæˆ‘è¦1è™Ÿé¤ã€ï¼Œè€Œä¸æ˜¯èªªã€Œæˆ‘è¦ä¸€å€‹æ¼¢å ¡ã€ä¸€ä»½ä¸­è–¯ã€ä¸€æ¯å¯æ¨‚ã€ã€‚
                                        ã€Œ1è™Ÿé¤ã€å°±æ˜¯ä¸€å€‹å‡½æ•¸åç¨±ï¼ŒåŒ…å«äº†ä¸€çµ„é£Ÿç‰©ã€‚
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                `
            },
            {
                id: "practice",
                title: "5. é‚è¼¯å·¥ç¨‹å¸«æŒ‘æˆ°",
                icon: "gamepad-2",
                render: () => `
                    <div class="game-wrapper h-[600px] flex flex-col border-2 border-slate-200 rounded-xl overflow-hidden shadow-lg font-sans">
                        <div class="bg-white p-4 flex justify-between items-center border-b border-slate-100">
                             <div class="font-bold text-slate-700 text-lg flex gap-2 items-center">
                                <i data-lucide="gamepad-2" class="text-purple-500"></i> é‚è¼¯å·¥ç¨‹å¸«è¨“ç·´
                             </div>
                             <div id="game-level-display" class="bg-blue-600 text-white px-4 py-1 rounded-full text-sm font-bold shadow">Level 1</div>
                        </div>
                        
                        <div class="flex flex-1 overflow-hidden bg-slate-50">
                            <div class="flex-[1.4] p-4 flex flex-col border-r border-slate-200 bg-slate-100">
                                 <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-orange-400 mb-4">
                                    <div class="text-xs font-bold text-slate-400 uppercase mb-1 flex items-center gap-1"><i data-lucide="alert-circle" class="w-3 h-3"></i> ç•¶å‰ä»»å‹™</div>
                                    <div id="mission-text" class="text-slate-700 font-medium leading-relaxed">Loading...</div>
                                 </div>
                                 <div id="canvas" class="flex-1 bg-white rounded-xl border-2 border-slate-200 relative overflow-hidden shadow-inner">
                                    <svg class="sprite robot-svg" id="robot" viewBox="0 0 100 100" style="left: 50px; bottom: 50px;">
                                        <circle cx="50" cy="50" r="45" fill="#cfd8dc" stroke="#37474f" stroke-width="2"/>
                                        <rect x="25" y="35" width="50" height="30" rx="5" fill="#37474f"/>
                                        <circle class="eye" cx="38" cy="50" r="5" fill="#00e676"/>
                                        <circle class="eye" cx="62" cy="50" r="5" fill="#00e676"/>
                                        <rect x="40" y="80" width="20" height="15" fill="#546e7a"/>
                                        <path d="M15 50 L5 40 M85 50 L95 40" stroke="#37474f" stroke-width="4" stroke-linecap="round"/>
                                    </svg>
                                    <div class="beam" id="beam"></div>
                                 </div>
                            </div>

                            <div class="flex-1 flex flex-col bg-white">
                                <div id="toolbox" class="p-3 bg-slate-50 border-b border-slate-200 flex flex-wrap gap-2 min-h-[80px] content-center">
                                    </div>
                                <div id="workspace" class="flex-1 p-6 overflow-y-auto bg-slate-50/50 relative">
                                     <div class="text-center text-slate-300 mt-10 pointer-events-none select-none text-sm">â˜Ÿ æ‹–æ”¾ç©æœ¨åˆ°é€™è£¡çµ„åˆç¨‹å¼</div>
                                </div>
                                <div class="p-4 border-t border-slate-100 flex items-center gap-2 bg-white shadow-up">
                                    <div id="game-msg-box" class="flex-1 font-bold text-slate-500 text-sm truncate">ç­‰å¾…æŒ‡ä»¤...</div>
                                    <button onclick="loadGameLevel(currentGameLevelIdx)" class="px-3 py-2 bg-slate-100 hover:bg-slate-200 rounded text-slate-600 font-bold text-sm transition flex items-center gap-1 border border-slate-200">
                                        <i data-lucide="rotate-ccw" class="w-3 h-3"></i> é‡ç½®
                                    </button>
                                    <button onclick="runGameCode()" class="px-4 py-2 bg-green-500 hover:bg-green-600 rounded text-white font-bold text-sm transition shadow-sm disabled:opacity-50 flex items-center gap-1 btn-run">
                                        <i data-lucide="play" class="w-3 h-3"></i> åŸ·è¡Œ
                                    </button>
                                    <button id="btn-next-level" onclick="nextGameLevel()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded text-white font-bold text-sm transition shadow-sm hidden animate-bounce flex items-center gap-1">
                                        ä¸‹ä¸€é—œ <i data-lucide="arrow-right" class="w-3 h-3"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `
            }
        ];

        let currentStep = 0;

        function init() {
            renderProgressBar();
            loadStep(0);
        }

        function renderProgressBar() {
            const container = document.getElementById('progressBar');
            container.innerHTML = tutorialSteps.map((step, index) => `
                <button onclick="loadStep(${index})" 
                    class="flex items-center gap-2 px-4 py-2 rounded-full whitespace-nowrap transition-colors mr-2
                    ${index === currentStep ? 'bg-blue-600 text-white shadow-md' : 'bg-white text-slate-500 hover:bg-slate-100'}">
                    <span class="w-6 h-6 flex items-center justify-center rounded-full text-xs font-bold ${index === currentStep ? 'bg-white text-blue-600' : 'bg-slate-200'}">${index + 1}</span>
                    <span>${step.title.split('.')[1]}</span>
                </button>
            `).join('');
        }

        function loadStep(index) {
            currentStep = index;
            document.getElementById('contentArea').innerHTML = tutorialSteps[index].render();
            document.getElementById('prevBtn').disabled = index === 0;
            document.getElementById('nextBtn').disabled = index === tutorialSteps.length - 1;
            renderProgressBar();
            lucide.createIcons();
            window.scrollTo({ top: 0, behavior: 'smooth' });

            // å¦‚æœæ˜¯éŠæˆ²é—œå¡ï¼Œåˆå§‹åŒ–éŠæˆ²
            if (tutorialSteps[index].id === 'practice') {
                initGame();
            }
        }

        function changeStep(delta) {
            const newStep = currentStep + delta;
            if (newStep >= 0 && newStep < tutorialSteps.length) {
                loadStep(newStep);
            }
        }

        /* --- Flow Simulation (Step 3) --- */
        async function runFlowSimulation() {
            playSound('click'); // æ’­æ”¾éŸ³æ•ˆ
            const els = {
                step1: document.getElementById('step1'),
                step2: document.getElementById('step2'),
                step3a: document.getElementById('step3a'),
                step3b: document.getElementById('step3b'),
                step4: document.getElementById('step4'),
                status: document.getElementById('flowStatus'),
                mainArea: document.getElementById('mainProgramArea'),
                funcArea: document.getElementById('funcDefArea')
            };

            const reset = () => {
                Object.values(els).forEach(el => {
                    if(el.classList) el.classList.remove('ring-4', 'ring-yellow-400', 'opacity-100');
                    if(el.classList && el.id && el.id.startsWith('step')) el.classList.add('opacity-30');
                });
                els.status.innerText = "æº–å‚™åŸ·è¡Œ...";
            };
            const highlight = (el, text) => {
                el.classList.remove('opacity-30');
                el.classList.add('ring-2', 'ring-yellow-400', 'opacity-100');
                els.status.innerText = text;
            };

            reset();
            highlight(els.step1, "ä¸»ç¨‹å¼: é¡¯ç¤º Start");
            await new Promise(r => setTimeout(r, 1000));
            els.step1.classList.remove('ring-2', 'ring-yellow-400');

            highlight(els.step2, "ä¸»ç¨‹å¼: å‘¼å«å‡½æ•¸ 'ç¬‘è‡‰'...");
            await new Promise(r => setTimeout(r, 1000));
            els.step2.classList.remove('ring-2', 'ring-yellow-400');

            els.mainArea.classList.add('opacity-50');
            els.funcArea.classList.add('ring-2', 'ring-blue-500');
            
            highlight(els.step3a, "å‡½æ•¸å…§: åŸ·è¡Œ LED é¡¯ç¤º");
            await new Promise(r => setTimeout(r, 1000));
            els.step3a.classList.remove('ring-2', 'ring-yellow-400');

            highlight(els.step3b, "å‡½æ•¸å…§: åŸ·è¡Œ æ’­æ”¾éŸ³æ•ˆ");
            await new Promise(r => setTimeout(r, 1000));
            els.step3b.classList.remove('ring-2', 'ring-yellow-400');

            els.funcArea.classList.remove('ring-2', 'ring-blue-500');
            els.mainArea.classList.remove('opacity-50');
            els.status.innerText = "å‡½æ•¸çµæŸï¼Œè¿”å›ä¸»ç¨‹å¼";
            await new Promise(r => setTimeout(r, 800));

            highlight(els.step4, "ä¸»ç¨‹å¼: é¡¯ç¤º End");
            await new Promise(r => setTimeout(r, 1000));
            els.status.innerText = "ç¨‹å¼åŸ·è¡Œå®Œç•¢";
            els.step4.classList.remove('ring-2', 'ring-yellow-400');
            playSound('success'); // æ’­æ”¾éŸ³æ•ˆ
        }

        /* --- Game Engine (Step 5) --- */
        const gameSVGs = {
            server: `<svg viewBox="0 0 100 100"><rect x="15" y="10" width="70" height="80" rx="4" fill="#546e7a"/><rect x="25" y="20" width="50" height="10" rx="2" fill="#263238"/><circle cx="30" cy="25" r="2" fill="#ff1744" class="status-light"/><rect x="25" y="40" width="50" height="10" rx="2" fill="#263238"/><circle cx="30" cy="45" r="2" fill="#ff1744" class="status-light"/><rect x="25" y="60" width="50" height="10" rx="2" fill="#263238"/><circle cx="30" cy="65" r="2" fill="#ff1744" class="status-light"/></svg>`,
            core: `<svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="#263238"/><circle cx="50" cy="50" r="20" fill="#ff1744"/><path d="M50 10 L50 30 M50 70 L50 90 M10 50 L30 50 M70 50 L90 50" stroke="#00e676" stroke-width="4"/></svg>`,
            shield: `<svg viewBox="0 0 100 100"><path d="M50 10 L90 25 V55 C90 75 50 95 50 95 C50 95 10 75 10 55 V25 Z" fill="#37474f" stroke="#0277bd" stroke-width="3"/><text x="35" y="60" fill="white" font-size="40" font-weight="bold">!</text></svg>`
        };

        const gameLevels = [
            {
                id: 1, title: "L1: å®šç¾©å·¥å…·",
                desc: "å®šç¾©ä¸€å€‹ <span class='tag'>å‡½æ•¸:ä¿®å¾©</span>ï¼Œæ”¾å…¥ <span class='tag'>ç™¼å°„ä¿®å¾©å…‰æŸ</span>ã€‚",
                targets: [{type: 'server', status: 'broken'}],
                blocks: [{type: 'func', text: 'å‡½æ•¸: ä¿®å¾©', id: 'def-fix', isContainer: true}, {type: 'action', text: 'ç™¼å°„ä¿®å¾©å…‰æŸ', id: 'act-fix'}],
                check: (ws) => {
                    const func = ws.querySelector('.block-func');
                    if(!func || !func.querySelector('.block-action')) return {pass: false, msg: "è«‹å®šç¾©å‡½æ•¸ä¸¦æ”¾å…¥ä¿®å¾©å‹•ä½œï¼"};
                    return {pass: true, actions: [{type: 'fix', index: 0}]};
                }
            },
            {
                id: 2, title: "L2: ä½¿ç”¨å·¥å…·",
                desc: "ä½¿ç”¨ <span class='tag'>ç•¶æŒ‰éˆ•AæŒ‰ä¸‹</span> äº‹ä»¶ï¼Œä¸¦ <span class='tag'>å‘¼å«:ä¿®å¾©</span>ã€‚",
                targets: [{type: 'server', status: 'broken'}],
                blocks: [{type: 'event', text: 'ç•¶æŒ‰éˆ• A è¢«æŒ‰ä¸‹', id: 'evt-a', isContainer: true}, {type: 'call', text: 'å‘¼å«: ä¿®å¾©', id: 'call-fix'}],
                check: (ws) => {
                    const evt = ws.querySelector('.block-event');
                    if(!evt || !evt.querySelector('.block-call')) return {pass: false, msg: "è«‹åœ¨äº‹ä»¶å…§å‘¼å«å‡½æ•¸ï¼"};
                    return {pass: true, actions: [{type: 'fix', index: 0}]};
                }
            },
            {
                id: 3, title: "L3: è¿´åœˆè™•ç†",
                desc: "ä½¿ç”¨ <span class='tag'>é‡è¤‡ 3 æ¬¡</span> è¿´åœˆä¾† <span class='tag'>å‘¼å«:ä¿®å¾©</span> 3 å°ä¼ºæœå™¨ã€‚",
                targets: [{type: 'server', status: 'broken'}, {type: 'server', status: 'broken'}, {type: 'server', status: 'broken'}],
                blocks: [{type: 'event', text: 'ç•¶æŒ‰éˆ• A è¢«æŒ‰ä¸‹', id: 'evt-a', isContainer: true}, {type: 'loop', text: 'é‡è¤‡ 3 æ¬¡', id: 'loop-3', isContainer: true}, {type: 'call', text: 'å‘¼å«: ä¿®å¾©', id: 'call-fix'}],
                check: (ws) => {
                    const loop = ws.querySelector('.block-loop');
                    if(!loop || !loop.querySelector('.block-call')) return {pass: false, msg: "è«‹åœ¨è¿´åœˆå…§å‘¼å«ä¿®å¾©ï¼"};
                    return {pass: true, actions: [{type: 'fix', index: 0}, {type: 'fix', index: 1}, {type: 'fix', index: 2}]};
                }
            },
            {
                id: 4, title: "L4: é‚è¼¯åˆ¤æ–·",
                desc: "åªæœ‰å£æ‰çš„æ‰ä¿®ï¼ç´…è‰²éç†±çš„ä¸è¦ä¿®ã€‚ä½¿ç”¨ <span class='tag'>å¦‚æœ &lt;å£æ‰&gt; å‰‡</span>ã€‚",
                targets: [{type: 'server', status: 'broken'}, {type: 'server', status: 'red-alert'}, {type: 'server', status: 'broken'}],
                blocks: [{type: 'event', text: 'ç•¶æŒ‰éˆ• A è¢«æŒ‰ä¸‹', id: 'evt-a', isContainer: true}, {type: 'loop', text: 'é‡è¤‡ 3 æ¬¡', id: 'loop-3', isContainer: true}, {type: 'logic', text: 'å¦‚æœ <ä¼ºæœå™¨å£æ‰> å‰‡', id: 'if-broken', isContainer: true}, {type: 'call', text: 'å‘¼å«: ä¿®å¾©', id: 'call-fix'}, {type: 'action', text: 'æƒæ', id: 'act-scan'}],
                check: (ws) => {
                    const loop = ws.querySelector('.block-loop');
                    const logic = loop ? loop.querySelector('.block-logic') : null;
                    const call = logic ? logic.querySelector('.block-call') : null;
                    if(!logic) return {pass: false, msg: "è«‹ä½¿ç”¨ã€Œå¦‚æœã€ç©æœ¨é€²è¡Œåˆ¤æ–·ï¼"};
                    if(!call) return {pass: false, msg: "å¦‚æœæ˜¯å£æ‰çš„ï¼Œæ‰å‘¼å«ä¿®å¾©ã€‚"};
                    
                    let acts = [];
                    [0, 1, 2].forEach(i => {
                        acts.push({type: 'scan', index: i});
                        if(gameLevels[3].targets[i].status === 'broken') acts.push({type: 'fix', index: i});
                    });
                    return {pass: true, actions: acts};
                }
            },
            {
                id: 5, title: "L5: æ ¸å¿ƒç ´è§£",
                desc: "é‡åˆ° <span class='tag'>ç›¾ç‰Œ</span> å‰‡ <span class='tag'>ç ´è§£</span>ï¼Œå¦å‰‡ <span class='tag'>ä¿®å¾©</span>ã€‚",
                targets: [{type: 'shield', status: 'shield'}, {type: 'core', status: 'broken'}, {type: 'shield', status: 'shield'}],
                blocks: [{type: 'event', text: 'ç•¶æŒ‰éˆ• A è¢«æŒ‰ä¸‹', id: 'evt-a', isContainer: true}, {type: 'loop', text: 'é‡è¤‡ 3 æ¬¡', id: 'loop-3', isContainer: true}, {type: 'logic', text: 'å¦‚æœ <é‡åˆ°ç›¾ç‰Œ> å‰‡ / å¦å‰‡', id: 'if-else', isContainer: true, hasElse: true}, {type: 'call', text: 'å‘¼å«: ç ´è§£', id: 'call-hack'}, {type: 'call', text: 'å‘¼å«: ä¿®å¾©', id: 'call-fix'}],
                check: (ws) => {
                    const logic = ws.querySelector('.block-logic');
                    const slots = logic ? logic.querySelectorAll('.game-slot') : [];
                    
                    if(slots.length < 2) return {pass: false, msg: "è«‹ä½¿ç”¨ If/Else ç©æœ¨ (å¿…é ˆåŒ…å«å¦å‰‡)"};
                    
                    const slot1 = slots[0]; // If éƒ¨åˆ†
                    const slot2 = slots[1]; // Else éƒ¨åˆ†
                    
                    const call1 = slot1.querySelector('.block-call');
                    const call2 = slot2.querySelector('.block-call');

                    if(call1 && call1.innerText.includes('ç ´è§£') && call2 && call2.innerText.includes('ä¿®å¾©')) {
                        return {pass: true, actions: [{type: 'hack', index: 0}, {type: 'fix', index: 1}, {type: 'hack', index: 2}]};
                    }
                    return {pass: false, msg: "é‚è¼¯éŒ¯èª¤ï¼šé‡åˆ°ç›¾ç‰Œæ‡‰è©²ã€Œç ´è§£ã€ï¼Œå¦å‰‡æ‡‰è©²ã€Œä¿®å¾©ã€ã€‚"};
                }
            }
        ];

        let currentGameLevelIdx = 0;

        function initGame() {
            loadGameLevel(currentGameLevelIdx);
            
            // Re-attach drop events to workspace
            const ws = document.getElementById('workspace');
            if(ws) {
                ws.addEventListener('dragover', e => e.preventDefault());
                ws.addEventListener('drop', handleGameDrop);
            }
        }

        function loadGameLevel(idx) {
            playSound('click'); // æ’­æ”¾éŸ³æ•ˆ
            currentGameLevelIdx = idx;
            const lvl = gameLevels[idx];
            
            const lvlDisplay = document.getElementById('game-level-display');
            if(lvlDisplay) lvlDisplay.innerText = lvl.title;
            
            const missionText = document.getElementById('mission-text');
            if(missionText) missionText.innerHTML = lvl.desc;
            
            const msgBox = document.getElementById('game-msg-box');
            if(msgBox) {
                msgBox.innerText = "ç­‰å¾…æŒ‡ä»¤...";
                msgBox.style.color = "#64748b";
            }

            const nextBtn = document.getElementById('btn-next-level');
            if(nextBtn) nextBtn.style.display = 'none';

            const runBtn = document.querySelector('.btn-run');
            if(runBtn) runBtn.disabled = false;

            const toolbox = document.getElementById('toolbox');
            if(toolbox) {
                toolbox.innerHTML = '';
                lvl.blocks.forEach(b => createGameBlock(b, toolbox));
            }

            const ws = document.getElementById('workspace');
            if(ws) ws.innerHTML = '<div class="text-center text-slate-300 mt-10 pointer-events-none select-none text-sm">â˜Ÿ æ‹–æ”¾ç©æœ¨åˆ°é€™è£¡çµ„åˆç¨‹å¼</div>';
            
            setupGameStage(lvl);
        }

        function setupGameStage(lvl) {
            // Remove old targets
            document.querySelectorAll('.target-svg').forEach(e => e.remove());
            const canvas = document.getElementById('canvas');
            const robot = document.getElementById('robot');
            if(!canvas || !robot) return;
            
            robot.style.left = '50px';
            
            lvl.targets.forEach((t, i) => {
                const div = document.createElement('div');
                div.className = `sprite target-svg ${t.status}`;
                div.innerHTML = gameSVGs[t.type] || gameSVGs.server;
                div.style.left = (180 + i * 110) + 'px'; // Adjust spacing for smaller container
                div.dataset.index = i;
                canvas.appendChild(div);
            });
        }

        function createGameBlock(data, container) {
            const el = document.createElement('div');
            el.className = `game-block block-${data.type}`;
            el.innerText = data.text;
            el.draggable = true;
            el.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('json', JSON.stringify(data));
                e.dataTransfer.effectAllowed = 'copy';
                playSound('click'); // æ’­æ”¾éŸ³æ•ˆ
            });
            
            // ä¿®æ­£å·¢ç‹€å®¹å™¨çš„é‚è¼¯
            if(data.isContainer) {
                el.style.minWidth = "160px";
                
                const createSlot = () => {
                    const slot = document.createElement('div'); 
                    slot.className = 'game-slot';
                    // ä¿®æ­£ï¼šäº‹ä»¶ç›£è½å™¨æ­£ç¢ºåœ°ç¶å®šåœ¨ slot ä¸Š
                    slot.addEventListener('dragenter', ev => {
                        ev.preventDefault(); 
                        ev.stopPropagation();
                        slot.classList.add('drag-over');
                    });
                    slot.addEventListener('dragleave', ev => {
                        ev.preventDefault(); 
                        ev.stopPropagation();
                        slot.classList.remove('drag-over');
                    });
                    slot.addEventListener('dragover', ev => {
                        ev.preventDefault(); 
                        ev.stopPropagation();
                    });
                    slot.addEventListener('drop', (e) => {
                        slot.classList.remove('drag-over');
                        handleGameDrop(e);
                    });
                    return slot;
                };

                el.appendChild(createSlot());

                if(data.hasElse) {
                    const div = document.createElement('div'); div.innerText = "å¦å‰‡"; 
                    div.style.padding = "2px 8px"; div.style.fontSize = "12px"; div.style.opacity = "0.8";
                    el.appendChild(div);
                    el.appendChild(createSlot());
                }
            }
            
            container.appendChild(el);
        }

        function handleGameDrop(e) {
            e.preventDefault(); e.stopPropagation();
            playSound('click'); // æ’­æ”¾éŸ³æ•ˆ
            
            const dataStr = e.dataTransfer.getData('json');
            if(!dataStr) return;
            const data = JSON.parse(dataStr);
            let target = e.target;
            
            // Find valid drop target
            let slot = target.classList.contains('game-slot') ? target : target.closest('.game-slot');
            const ws = document.getElementById('workspace');
            let container = slot || ws;
            
            if(ws.innerText.includes('æ‹–æ”¾ç©æœ¨')) ws.innerHTML = '';

            // é‡æ–°å»ºç«‹ç©æœ¨ DOM (å› ç‚ºè¦æ”¾åœ¨æ–°ä½ç½®)
            // é€™è£¡ç›´æ¥å‘¼å« createGameBlock çš„ç°¡åŒ–ç‰ˆé‚è¼¯ä¾†ç”¢ç”Ÿ DOM
            const newBlock = document.createElement('div');
            newBlock.className = `game-block block-${data.type}`;
            newBlock.innerText = data.text;
            newBlock.ondblclick = (e) => { e.stopPropagation(); newBlock.remove(); playSound('click'); };

            if(data.isContainer) {
                newBlock.style.minWidth = "160px";
                const createSlot = () => {
                    const slot = document.createElement('div'); 
                    slot.className = 'game-slot';
                    slot.addEventListener('dragenter', ev => {
                        ev.preventDefault(); ev.stopPropagation(); slot.classList.add('drag-over');
                    });
                    slot.addEventListener('dragleave', ev => {
                        ev.preventDefault(); ev.stopPropagation(); slot.classList.remove('drag-over');
                    });
                    slot.addEventListener('dragover', ev => {
                        ev.preventDefault(); ev.stopPropagation();
                    });
                    slot.addEventListener('drop', (ev) => {
                        slot.classList.remove('drag-over');
                        handleGameDrop(ev);
                    });
                    return slot;
                };

                newBlock.appendChild(createSlot());

                if(data.hasElse) {
                    const div = document.createElement('div'); div.innerText = "å¦å‰‡"; 
                    div.style.padding = "2px 8px"; div.style.fontSize = "12px"; div.style.opacity = "0.8";
                    newBlock.appendChild(div);
                    newBlock.appendChild(createSlot());
                }
            }

            container.appendChild(newBlock);
        }

        async function runGameCode() {
            playSound('click'); // æ’­æ”¾éŸ³æ•ˆ
            const lvl = gameLevels[currentGameLevelIdx];
            const ws = document.getElementById('workspace');
            const res = lvl.check(ws);
            const msg = document.getElementById('game-msg-box');

            if(!res.pass) {
                playSound('fail'); // æ’­æ”¾å¤±æ•—éŸ³æ•ˆ
                msg.innerText = "âŒ " + res.msg;
                msg.style.color = "#d32f2f";
                ws.animate([{transform: 'translateX(0)'}, {transform: 'translateX(-5px)'}, {transform: 'translateX(5px)'}, {transform: 'translateX(0)'}], {duration: 300});
                return;
            }

            msg.innerText = "âš¡ åŸ·è¡Œä¸­...";
            msg.style.color = "#00c853";
            document.querySelector('.btn-run').disabled = true;
            await executeGameActions(res.actions);
        }

        async function executeGameActions(actions) {
            const robot = document.getElementById('robot');
            const beam = document.getElementById('beam');
            const canvas = document.getElementById('canvas');
            const msg = document.getElementById('game-msg-box');

            for(let action of actions) {
                const targetEl = document.querySelector(`.target-svg[data-index='${action.index}']`);
                if(!targetEl) continue;

                // Move robot close to target
                const targetX = targetEl.offsetLeft;
                robot.style.left = (targetX - 80) + 'px';
                await wait(600);

                if(action.type === 'fix' || action.type === 'hack') {
                    playSound('laser'); // æ’­æ”¾é›·å°„éŸ³æ•ˆ
                    const startX = robot.offsetLeft + 60;
                    const endX = targetEl.offsetLeft + 30;
                    
                    beam.style.left = startX + 'px';
                    beam.style.top = (robot.offsetTop + 35) + 'px';
                    beam.style.width = (endX - startX) + 'px';
                    beam.style.background = action.type === 'hack' ? '#ff9100' : '#00e676';
                    beam.style.boxShadow = action.type === 'hack' ? '0 0 15px #ff9100' : '0 0 15px #00e676';
                    beam.style.opacity = 1;

                    canvas.classList.add('shake');
                    spawnParticles(endX, targetEl.offsetTop + 30, action.type === 'hack' ? '#ff9100' : '#00e676');
                    await wait(500);
                    
                    beam.style.opacity = 0;
                    canvas.classList.remove('shake');
                    targetEl.className = 'sprite target-svg fixed';
                    if(action.type === 'hack') targetEl.style.opacity = 0.5;

                } else if (action.type === 'scan') {
                    robot.style.filter = "drop-shadow(0 0 10px #2979ff)";
                    await wait(300);
                    robot.style.filter = "none";
                }
                await wait(300);
            }

            playSound('success'); // æ’­æ”¾æˆåŠŸéŸ³æ•ˆ
            msg.innerText = "ğŸ† ä»»å‹™å®Œæˆï¼";
            msg.style.color = "#00c853";
            document.getElementById('btn-next-level').style.display = 'flex';
        }

        function spawnParticles(x, y, color) {
            const canvas = document.getElementById('canvas');
            for(let i=0; i<8; i++) {
                const p = document.createElement('div');
                p.className = 'particle';
                p.style.background = color;
                p.style.left = x + 'px'; p.style.top = y + 'px';
                canvas.appendChild(p);
                const angle = Math.random() * 6.28;
                const dist = Math.random() * 40 + 10;
                p.animate([{transform: 'translate(0,0) scale(1)', opacity: 1}, {transform: `translate(${Math.cos(angle)*dist}px, ${Math.sin(angle)*dist}px) scale(0)`, opacity: 0}], {duration: 600}).onfinish = () => p.remove();
            }
        }
        
        function nextGameLevel() {
            playSound('click'); // æ’­æ”¾éŸ³æ•ˆ
            if(currentGameLevelIdx < gameLevels.length - 1) loadGameLevel(currentGameLevelIdx + 1);
            else {
                const msg = document.getElementById('game-msg-box');
                msg.innerText = "ğŸ‰ æ­å–œï¼ä½ å·²å®Œæˆæ‰€æœ‰é‚è¼¯å·¥ç¨‹å¸«è¨“ç·´ï¼";
                msg.style.color = "#d946ef";
                playSound('success');
            }
        }
        
        function wait(ms) { return new Promise(r => setTimeout(r, ms)); }

        // Start
        window.onload = init;

    </script>
</body>
</html>